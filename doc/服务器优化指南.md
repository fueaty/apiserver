# 2核2G服务器优化指南

## 问题分析

您说得非常对！2核2G的服务器运行Redis+Celery确实需要仔细优化，否则容易出现内存不足和性能问题。

## 已实施的优化措施

### 1. Redis配置优化
- **内存限制**: 限制Redis最大内存使用为256MB
- **内存策略**: 使用`allkeys-lru`策略，内存不足时自动删除最近最少使用的key
- **连接数限制**: 最大连接数从20减少到10
- **持久化优化**: 关闭AOF持久化，减少磁盘IO压力
- **数据结构优化**: 优化哈希、列表、集合等数据结构的存储效率

### 2. Celery配置优化
- **事件跟踪**: 关闭任务开始和发送事件跟踪，减少内存占用
- **任务超时**: 将任务超时时间从5分钟减少到3分钟
- **错误处理**: 简化错误处理机制，减少资源消耗
- **内存限制**: 限制每个工作进程最大内存使用为100MB

### 3. 系统级优化建议

#### Redis启动优化
```bash
# 使用优化后的配置文件启动Redis
redis-server /root/apiserver/config/redis.conf

# 或者使用内存优化参数启动
redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
```

#### Celery启动优化
```bash
# 限制工作进程数量，避免内存不足
celery -A app.core.celery_config.celery_app worker \
    --loglevel=info \
    --concurrency=2 \  # 限制并发数为2
    --max-tasks-per-child=50 \
    --prefetch-multiplier=1
```

#### 系统监控命令
```bash
# 查看内存使用情况
free -h

# 查看Redis内存使用
redis-cli info memory

# 查看Celery进程
ps aux | grep celery

# 系统负载监控
top
```

## 进一步优化建议

### 1. 使用Redis替代方案（如果内存仍然不足）
- **SQLite作为消息队列**: 对于轻量级任务，可以使用SQLite替代Redis
- **文件系统队列**: 使用磁盘文件作为简单的任务队列
- **内存映射文件**: 使用mmap实现轻量级队列

### 2. 任务调度优化
- **批量处理**: 将多个小任务合并为批量任务
- **延迟执行**: 非紧急任务可以延迟执行
- **优先级队列**: 重要任务优先执行

### 3. 监控和告警
- 设置内存使用阈值告警
- 监控任务队列积压情况
- 定期清理过期任务结果

## 紧急处理方案

如果服务器出现内存不足：

1. **立即重启Redis**: `sudo systemctl restart redis`
2. **清理Celery任务结果**: `redis-cli flushdb`
3. **重启Celery工作进程**
4. **临时增加swap空间**（如果支持）

## 性能测试建议

在正式部署前，建议进行压力测试：

```bash
# 使用ab进行简单压力测试
ab -n 100 -c 10 http://localhost:8000/api/v1/tasks/

# 监控系统资源使用
htop
```

## 总结

通过以上优化，2核2G服务器应该能够稳定运行Redis+Celery组合。关键是要严格控制内存使用，并做好监控和应急准备。