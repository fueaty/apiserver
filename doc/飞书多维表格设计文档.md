# 飞书多维表格设计文档

## 1. 表结构设计

### 1.1 AI Headlines Pipeline (headlines)
- **用途**: 存放微博等热点采集的头条数据
- **主要字段**:
  - id: 唯一标识（时间戳+5位随机字符格式）
  - title: 标题
  - url: 原始链接
  - content: 内容摘要
  - author: 作者
  - category: 分类
  - hot: 热度值
  - rank: 排名
  - collected_at: 采集时间
  - site_code: 站点编码
  - status: 状态

### 1.2 AI Insights Archive (ai_insights)
- **用途**: 存放AI生成的深度分析内容
- **主要字段**:
  - id: 唯一标识（时间戳+5位随机字符格式）
  - title: 标题
  - url: 原始链接
  - content: 完整内容
  - author: 作者
  - category: 分类
  - summary: 摘要
  - tags: 标签
  - seo_title: SEO标题
  - seo_description: SEO描述
  - seo_keywords: SEO关键词
  - published_at: 发布时间
  - status: 状态

### 1.3 Content Distribution Tracker (distribution)
- **用途**: 存放内容分发渠道及状态
- **主要字段**:
  - id: 唯一标识（时间戳+5位随机字符格式）
  - title: 标题
  - content: 内容
  - url: 原始链接
  - platform_code: 平台编码
  - published_url: 发布链接
  - status: 状态
  - error_message: 错误信息
  - published_at: 发布时间

### 1.4 Platform Management (platform_configs)
- **用途**: 管理各内容平台的配置信息
- **主要字段**:
  - id: 唯一标识（时间戳+5位随机字符格式）
  - platform_id: 平台ID
  - platform_name: 平台名称
  - enabled: 是否启用
  - core_domains: 核心内容领域
  - primary_domain: 主要内容领域
  - secondary_domain: 次要内容领域
  - content_style: 内容风格
  - optimal_word_count: 最佳字数
  - best_publish_time: 最佳发布时间
  - avoid_domains: 避免领域
  - scoring_weight: 评分权重
  - updated_date: 更新日期

### 1.5 Content Selection Engine (selections)
- **用途**: 存放智能选材结果
- **主要字段**:
  - id: 唯一标识（时间戳+5位随机字符格式）
  - headline_id: 热点ID（关联headlines表）
  - platform_code: 平台编码
  - match_score: 匹配度评分
  - recommended_angle: 推荐角度
  - strategy: 策略
  - reasoning: 推荐理由
  - created_at: 创建时间

### 1.6 Content Selection Rules (content_selection)
- **用途**: 定义各平台的内容选择规则
- **主要字段**:
  - rule_id: 规则ID
  - platform_id: 平台ID
  - target_audience: 目标受众
  - content_preference: 内容偏好
  - content_form: 内容形式
  - authority_requirement: 权威性要求
  - timeliness_requirement: 时效性要求
  - interactivity_requirement: 互动性要求
  - avoid_keywords: 避免关键词
  - rule_enabled: 规则是否启用

### 1.7 Data Sources Configuration (data_sources)
- **用途**: 管理各种数据采集源
- **主要字段**:
  - source_id: 源ID
  - source_name: 源名称
  - source_type: 源类型
  - authority_level: 权威等级
  - collection_frequency: 采集频率
  - source_enabled: 是否启用
  - collection_url: 采集地址
  - last_collection_time: 最后采集时间
  - collection_success_rate: 采集成功率

### 1.8 Content Publishing Tasks (publish_tasks)
- **用途**: 跟踪内容发布任务状态
- **主要字段**:
  - task_id: 任务ID
  - content_id: 内容ID
  - platform_id: 平台ID
  - task_status: 任务状态
  - scheduled_publish_time: 计划发布时间
  - actual_publish_time: 实际发布时间
  - publish_result: 发布结果
  - publish_link: 发布链接
  - views: 浏览量
  - likes: 点赞数
  - comments: 评论数

### 1.9 Content Quality Monitoring (content_evaluation)
- **用途**: 评估和监控内容质量
- **主要字段**:
  - evaluation_id: 评估ID
  - content_id: 内容ID
  - platform_fit: 平台适配度
  - content_quality_score: 内容质量评分
  - authority_score: 权威性评分
  - timeliness_score: 时效性评分
  - interaction_potential_score: 互动潜力评分
  - risk_assessment: 风险评估
  - evaluation_time: 评估时间
  - evaluator: 评估人

## 2. 字段规范

### 2.1 字段类型
所有字段均定义为文本类型（text），以确保数据处理的一致性和兼容性。

### 2.2 ID生成规范
所有表格的ID字段均采用统一格式：时间戳+5位随机字符，通过[/root/apiserver/secret/generate_auth_key.py](file:///root/apiserver/secret/generate_auth_key.py)中的[generate_content_id()](file:///root/apiserver/secret/generate_auth_key.py#L21-L28)函数生成。

## 3. 表关系说明

- headlines表为数据采集的核心表，存储原始采集数据
- ai_insights表存储AI处理后的深度内容
- distribution表跟踪内容在各平台的发布状态
- platform_configs表管理各平台的配置信息
- selections表存储智能选材结果，关联headlines表
- content_selection表定义各平台的内容选择规则
- data_sources表管理各种数据采集源
- publish_tasks表跟踪内容发布任务状态
- content_evaluation表评估和监控内容质量

## 4. 数据流说明

1. 采集模块将数据存入headlines表
2. 选材引擎从headlines表读取数据，处理后将结果存入selections表
3. 发布模块从selections表读取数据进行内容发布，并将发布结果存入distribution表
4. AI分析模块可从headlines表读取数据，处理后将深度内容存入ai_insights表

## 5. 数据采集入库规范

数据采集模块采集的数据主要存储到飞书多维表格中的"AI Headlines Pipeline"表（英文表名：headlines）。该表专门用于记录微博等平台的热点采集头条数据，是数据采集的核心落地表。

当数据采集模块完成数据采集后，会将相关内容通过API同步到指定的飞书多维表格中。采集到的数据会经过处理和格式化，然后通过`/api/v1/feishu/sync`接口同步到飞书多维表格中。

## 6. 视图设计

### 6.1 平台管理视图

**视图名称：启用平台列表 (Enabled Platforms)**
- 过滤条件：enabled = 启用
- 显示字段：platform_id、platform_name、core_domains、primary_domain、secondary_domain、best_publish_time、weight
- 排序规则：按weight降序排列

**视图名称：平台按领域分类 (Platforms by Domain)**
- 分组字段：core_domains
- 显示字段：platform_name、primary_domain、secondary_domain、content_form、best_word_count、best_publish_time
- 图表类型：分组表格

### 6.2 内容选材视图

**视图名称：启用规则列表 (Enabled Rules)**
- 过滤条件：enabled = 启用
- 显示字段：rule_id、platform_id、target_audience、content_preference、authority_level、timeliness_requirement、engagement_potential
- 排序规则：按platform_id分组

**视图名称：规则按平台分布 (Rules by Platform)**
- 分组字段：platform_id
- 显示字段：rule_id、content_preference、content_form、avoid_keywords
- 图表类型：甘特图

### 6.3 采集源管理视图

**视图名称：启用采集源 (Enabled Sources)**
- 过滤条件：enabled = 启用
- 显示字段：source_id、source_name、source_type、authority_level、collection_frequency、success_rate
- 排序规则：按success_rate降序排列

**视图名称：采集源健康状态 (Source Health Status)**
- 显示字段：source_name、source_type、last_collected_at、success_rate
- 图表类型：仪表盘
- 颜色标识：
  - success_rate ≥ 95%：绿色
  - 90% ≤ success_rate < 95%：黄色
  - success_rate < 90%：红色

### 6.4 发布任务视图

**视图名称：今日发布计划 (Today's Schedule)**
- 过滤条件：scheduled_publish_time = 当天
- 显示字段：task_id、platform_id、scheduled_publish_time、task_status
- 排序规则：按scheduled_publish_time升序排列

**视图名称：发布结果统计 (Publish Results)**
- 分组字段：publish_result
- 显示字段：platform_id、task_id、published_at、view_count、like_count、comment_count
- 图表类型：柱状图

**视图名称：平台效果对比 (Platform Comparison)**
- 分组字段：platform_id
- 显示字段：task_count、success_count、fail_count、avg_view_count、avg_like_count、avg_comment_count
- 图表类型：雷达图

### 6.5 内容质量评估视图

**视图名称：高质量内容 (High Quality Content)**
- 过滤条件：content_quality_score ≥ 8.0 且 platform_fit_score ≥ 80%
- 显示字段：content_id、platform_id、content_quality_score、platform_fit_score、risk_level
- 排序规则：按content_quality_score降序排列

**视图名称：内容风险监控 (Content Risk Monitoring)**
- 过滤条件：risk_level = 中风险 或 risk_level = 高风险
- 显示字段：content_id、risk_level、evaluated_at、evaluator
- 排序规则：按risk_level等级降序排列

## 7. 自动化流程设计

### 7.1 发布任务自动创建
```
触发条件：内容选材完成
执行动作：自动创建发布任务
关联字段：content_id → task_id
```

### 7.2 质量评估提醒
```
触发条件：content_quality_score < 6.0
执行动作：发送飞书提醒
提醒内容：内容质量需要人工审核
```

### 7.3 风险内容预警
```
触发条件：risk_level = 高风险
执行动作：暂停发布并通知负责人
通知方式：飞书群组@相关人员
```

## 8. 数据统计指标

### 8.1 平台维度统计
- 各平台发布成功率
- 平台内容适配度分析
- 平台互动效果对比

### 8.2 内容维度统计
- 内容质量分布
- 风险内容比例
- 优质内容特征分析

### 8.3 时间维度统计
- 日/周/月发布量趋势
- 发布时间段效果分析
- 季节性内容表现

## 9. 权限管理设计

### 9.1 角色定义
- **管理员**：全权限管理，配置修改
- **运营人员**：内容发布、监控查看
- **审核人员**：内容质量评估、风险审核
- **观察者**：只读权限，数据查看

### 9.2 字段级权限
- 敏感字段（如规避关键词）仅管理员可见
- 风险评估字段仅审核人员可编辑
- 发布链接字段所有角色可见

## 10. 集成接口设计

### 10.1 API数据同步
```python
# 发布任务状态同步
POST /feishu/sync/task-status
{
    "task_id": "task_001",
    "status": "success",
    "url": "https://zhuanlan.zhihu.com/p/123456"
}

# 内容质量评估同步
POST /feishu/sync/quality-evaluation
{
    "content_id": "content_001",
    "quality_score": 8.5,
    "risk_level": "low"
}
```