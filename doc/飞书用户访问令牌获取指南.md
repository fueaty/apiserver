# 飞书用户访问令牌获取指南

## 什么是用户访问令牌

用户访问令牌（User Access Token）是飞书开放平台中用于代表特定用户身份调用API的凭证。与应用级的租户访问令牌不同，用户访问令牌具有用户级别的权限，可以执行一些需要用户身份的操作，如删除多维表格中的字段。

## 为什么需要用户访问令牌

在本项目中，删除飞书多维表格字段的操作需要使用用户访问令牌，这是因为：
1. 删除字段是高权限操作，需要用户级别的授权
2. 飞书API设计要求此类操作必须使用用户访问令牌而非应用级令牌

## 如何获取用户访问令牌

### 方法一：通过飞书开放平台API调试台（推荐用于测试）

1. 登录[飞书开放平台](https://open.feishu.cn/)
2. 进入你的应用管理页面
3. 在左侧菜单中找到"开发者工具" -> "API调试台"
4. 选择"bitable.v1.app_table_field.delete"接口
5. 在"Token配置"区域，点击"获取用户授权"
6. 使用具有表格管理权限的飞书账号扫码授权
7. 授权成功后，系统会显示用户访问令牌

### 方法二：通过OAuth授权流程（推荐用于生产环境）

对于外部系统对接飞书API，需要通过标准的OAuth授权流程获取用户访问令牌：

1. 在飞书开放平台配置应用的重定向URL
2. 引导用户访问授权URL：
   ```
   https://open.feishu.cn/open-apis/authen/v1/authorize?app_id=YOUR_APP_ID&redirect_uri=YOUR_REDIRECT_URI&scope=bitable:app&state=RANDOM_STATE
   ```
3. 用户授权后，飞书会重定向到你的回调URL，并附带授权码(code)
4. 使用授权码获取用户访问令牌：
   ```bash
   curl -X POST 'https://open.feishu.cn/open-apis/authen/v1/access_token' \
   -H 'Content-Type: application/json' \
   -d '{
     "app_id": "YOUR_APP_ID",
     "app_secret": "YOUR_APP_SECRET",
     "grant_type": "authorization_code",
     "code": "AUTHORIZATION_CODE"
   }'
   ```

### 方法三：通过飞书客户端获取

1. 在飞书客户端中打开多维表格
2. 点击右上角"更多"按钮（三个点）
3. 选择"集成" -> "API"
4. 按照提示操作获取用户访问令牌

## 如何更新用户访问令牌

### 方法一：使用命令行工具（推荐）

```bash
# 直接通过命令行参数更新
python /root/apiserver/tests/update_user_token_cli.py YOUR_NEW_TOKEN

# 通过文件更新
echo "YOUR_NEW_TOKEN" > /tmp/token.txt
python /root/apiserver/tests/update_user_token_cli.py --file /tmp/token.txt
```

### 方法二：交互式更新

```bash
python /root/apiserver/tests/update_user_token_cli.py
```

### 方法三：手动编辑配置文件

编辑 `/root/apiserver/config/credentials.yaml` 文件，在 `feishu` 部分添加或修改 `user_access_token` 字段：

```yaml
feishu:
  app_id: "your_app_id"
  app_secret: "your_app_secret"
  user_access_token: "your_user_access_token"  # 添加或更新这一行
```

## 令牌过期处理

用户访问令牌通常有较短的有效期（几小时到几天），过期后需要重新获取。当出现以下错误时，表明令牌已过期：

```
[FeishuService] 删除字段 xxx 失败，令牌问题: 删除字段失败，字段ID: fldxxx，状态码: 401，响应: {"code":99991677,"msg":"Authentication token expired. Please request a new one."}
```

遇到这种情况时，请按照上述方法更新用户访问令牌。

## 注意事项

1. 用户访问令牌具有较高的权限，请妥善保管，不要泄露
2. 令牌过期是正常现象，定期更新即可
3. 确保使用的用户账号具有相应的表格管理权限
4. 不同的飞书组织可能有不同的令牌获取流程，请参考对应组织的文档
5. 对于生产环境，建议实现自动刷新令牌的机制